---
title: åŸºäºäº‘å¼€å‘ CloudBase æ­å»ºåœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨
description: 'åœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨æ˜¯åŸºäºæµè§ˆå™¨çš„èƒ½åŠ› WebRTC ä»¥åŠ è…¾è®¯äº‘å¼€å‘ CloudBase èƒ½åŠ›æ„å»ºè€Œæˆçš„åº”ç”¨. åœ¨äº‘å¼€å‘çš„åŠ©åŠ›ä¸‹, ä¸€ä¸ªå¤æ‚çš„åœ¨çº¿ä¼šè®®åº”ç”¨, ä¸€ä¸ªäººä¸€ä¸¤å¤©å³å¯å®Œæˆ.'
banner: 'https://main.qcloudimg.com/raw/32b06bb115f94d89e720cce6c9381022.png'
# github ç”¨æˆ·å
authorIds:
  - oe
  - binggg
platforms:
  - Web
tags:
  - å®æ—¶æ¨é€
  - æ•°æ®åº“
  - ClouBase Framework
  - é™æ€ç½‘ç«™æ‰˜ç®¡
---

![](https://main.qcloudimg.com/raw/32b06bb115f94d89e720cce6c9381022.png)

# åŸºäºäº‘å¼€å‘ CloudBase æ­å»ºåœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨

åœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨æ˜¯åŸºäºæµè§ˆå™¨çš„èƒ½åŠ› WebRTC ä»¥åŠ è…¾è®¯äº‘å¼€å‘ CloudBase èƒ½åŠ›æ„å»ºè€Œæˆçš„åº”ç”¨. åœ¨äº‘å¼€å‘çš„åŠ©åŠ›ä¸‹, ä¸€ä¸ªå¤æ‚çš„åœ¨çº¿ä¼šè®®åº”ç”¨, ä¸€ä¸ªäººä¸€ä¸¤å¤©å³å¯å®Œæˆ.

## åœ¨çº¿ä½“éªŒ Demo

åº”ç”¨ä½“éªŒåœ°å€: [Online Meeting Powered by Tencent Cloudbase](https://tcb-demo-10cf5b-1302484483.tcloudbaseapp.com/meeting-simple/)  
é¡¹ç›®æºç åœ°å€: [Github](https://github.com/oe/serverless-zoom-with-webrtc/tree/master/meeting-simple)

> æ³¨: åº”ç”¨ä»…ä¾›æ¼”ç¤ºä¹‹ç”¨, ç›®å‰ä»…æ”¯æŒä¸¤äººè§†é¢‘ä¼šè®®, åŠŸèƒ½è¿˜ä¸å¤Ÿå®Œå–„, è¿˜æœ‰è®¸å¤šå¯å®Œå–„ä¹‹å¤„.  
> åˆ›å»ºä¼šè®®åå¯å°†ä¼šè®®åœ°å€å‘ç»™ä»–äºº, æˆ–è€…åœ¨æœ¬æœºå¦èµ·ä¸€æµè§ˆå™¨çª—å£(æœªé¿å…æ•°æ®æ··ä¹±, å¯å¼€éšç§æ¨¡å¼çª—å£, æˆ–ä½¿ç”¨å¦ä¸€ä¸ªæµè§ˆå™¨)æ‰“å¼€ä¼šè®®åœ°å€ æ¥ä½“éªŒ

## åœ¨è‡ªå·±çš„äº‘å¼€å‘ç¯å¢ƒä¸­éƒ¨ç½²

å¯ä»¥åœ¨çº¿ä¸€é”®éƒ¨ç½²æˆ–é€šè¿‡æœ¬åœ°éƒ¨ç½²çš„æ–¹å¼ï¼Œæ¥ç‹¬ç«‹éƒ¨ç½²ä¸€ä¸ªè‡ªå·±çš„åœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨

### åœ¨çº¿ä¸€é”®éƒ¨ç½²

åªéœ€è¦ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œè·³è½¬åˆ°è…¾è®¯äº‘æ§åˆ¶å°ï¼Œå³å¯åœ¨äº‘ç«¯ä¸€é”®å®‰è£…ä¸€ä¸ªåœ¨çº¿è§†é¢‘ä¼šè®®åº”ç”¨

[![](https://main.qcloudimg.com/raw/95b6b680ef97026ae10809dbd6516117.svg)](https://console.cloud.tencent.com/tcb/env/index?action=CreateAndDeployCloudBaseProject&tdl_anchor=github&tdl_site=0&appUrl=https%3A%2F%2Fgithub.com%2Foe%2Fserverless-zoom-with-webrtc&workDir=meeting-simple&appName=meeting-simple)

### æœ¬åœ°éƒ¨ç½²

1. ä¿®æ”¹ .env æ–‡ä»¶ä¸­çš„ ` ENV_ID` çš„å€¼ `tcb-demo-10cf5b` ä¿®æ”¹ä¸ºè‡ªå·±çš„ç¯å¢ƒ ID
2. å‘½ä»¤è¡Œ cd åˆ°æœ¬ç›®å½•ä¸­, æ‰§è¡Œ `npm run deploy` å³å¯

## æŠ€æœ¯è§£æ

æœ¬åº”ç”¨ç”¨åˆ°çš„èƒ½åŠ›ã€å·¥å…·ã€æ¡†æ¶æœ‰:

1. **[CloudBase Framework](https://github.com/Tencent/cloudbase-framework)** ç”¨äºé¡¹ç›®åŸºç¡€ç›®å½•ç»“æ„ç”Ÿæˆ, ä¸€é”®éƒ¨ç½²
2. [Simple Peer](https://github.com/feross/simple-peer) æµè¡Œçš„ WebRTC åº“
3. [äº‘å¼€å‘-äº‘å‡½æ•°](https://docs.cloudbase.net/cloud-function/introduce.html), åŒ…æ‹¬äº‘å‡½æ•°çš„å®šæ—¶è°ƒç”¨
4. [äº‘å¼€å‘-æ•°æ®åº“](https://docs.cloudbase.net/database/introduce.html)
5. [äº‘å¼€å‘-é™æ€ç½‘ç«™æ‰˜ç®¡](https://docs.cloudbase.net/hosting/introduce.html)
6. [React](https://reactjs.bootcss.com/)
7. [Ant design](https://ant.design)

å¦‚æœä½ ä¸æ¸…æ¥šé¡¹ç›®å¼€å‘çš„åŸºæœ¬å‘½ä»¤, å¯é˜…è¯»æœ¬é¡¹ç›®ä½¿ç”¨çš„[æ¨¡ç‰ˆçš„ readme.md](https://github.com/TencentCloudBase/cloudbase-templates/blob/master/react-starter/README.md)

## èƒŒæ™¯çŸ¥è¯†

### Web RTC

1. WebRTC å³ Web å®æ—¶é€šä¿¡æŠ€æœ¯, ç”±ä¸€ç³»åˆ—æµè§ˆå™¨ API ç»„æˆ, åŒ…æ‹¬ _navigator.getUserMedia\*\*,_ _MediaStream**, RTC**ç›¸å…³çš„å…¨å±€å¯¹è±¡_

2. WebRTC æ˜¯ä¸€ç§ P2P çš„é€šä¿¡æŠ€æœ¯, æµè§ˆå™¨ä¹‹é—´å¯ä»¥å¯¹ç­‰è¿æ¥. ä½†æµè§ˆå™¨ä¹‹é—´éœ€è¦é€šè¿‡ä¸€ä¸ªä¿¡ä»¤æœåŠ¡å™¨æ¥äº¤æ¢ä¿¡ä»¤åæ–¹å¯å»ºç«‹è¿æ¥

3. æµè§ˆå™¨çš„ä¿¡ä»¤ä¿¡æ¯çš„è·å–éœ€è¦ä¸€ä¸ª ICE æœåŠ¡å™¨, ä¸€èˆ¬é»˜è®¤ä¼šä½¿ç”¨è°·æ­Œçš„å…¬å…±æœåŠ¡å™¨

![image-20200901204938345](https://tva1.sinaimg.cn/large/007S8ZIlgy1gibfw2ufgqj30tu0du41w.jpg)

![image-20200901204916919](https://tva1.sinaimg.cn/large/007S8ZIlgy1gibfvpv37vj30p60gajw6.jpg)

## äº‘å¼€å‘

äº‘å¼€å‘ï¼ˆCloudBaseï¼‰æ˜¯äº‘ç«¯ä¸€ä½“åŒ–çš„åç«¯äº‘æœåŠ¡ ï¼Œé‡‡ç”¨ serverless æ¶æ„ï¼Œå…å»äº†åº”ç”¨æ„å»ºä¸­ç¹ççš„æœåŠ¡å™¨æ­å»ºå’Œè¿ç»´ã€‚åŒæ—¶äº‘å¼€å‘æä¾›çš„é™æ€æ‰˜ç®¡ã€å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰ã€Flutter SDK ç­‰èƒ½åŠ›é™ä½äº†åº”ç”¨å¼€å‘çš„é—¨æ§›ã€‚ä½¿ç”¨äº‘å¼€å‘å¯ä»¥æ„å»ºå®Œæ•´çš„å°ç¨‹åº/å°æ¸¸æˆã€H5ã€Webã€ç§»åŠ¨ App ç­‰åº”ç”¨ã€‚

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gibh9r5ingj31hc0u00yz.jpg)

### CloudBase Framework

CloudBase Framework æ˜¯äº‘å¼€å‘å®˜æ–¹å‡ºå“çš„å¼€æºå‰åç«¯ä¸€ä½“åŒ–éƒ¨ç½²å·¥å…·ï¼Œæ— éœ€æ”¹åŠ¨ä»£ç ï¼Œå®ç°å‰åç«¯ä¸€é”®æ‰˜ç®¡éƒ¨ç½²ï¼Œæ”¯æŒå¸¸è§çš„æ¡†æ¶å’Œè¯­è¨€ï¼Œæ”¯æŒè‡ªåŠ¨è¯†åˆ«å¹¶éƒ¨ç½²ã€‚ä¸ä»…å¯ä»¥éƒ¨ç½²åº”ç”¨å‰åç«¯åˆ° Serverlessï¼Œè¿˜å¯ä»¥æ‰©å±•æ›´å¤šåç«¯èƒ½åŠ›ã€‚

![img](https://main.qcloudimg.com/raw/952b432a3b0688cc2f40e23b09c3fffa.png)

Github åœ°å€ï¼š https://github.com/Tencent/cloudbase-framework

![](https://main.qcloudimg.com/raw/a9debe766e8de780f76e20aeb815317d.png)

## å®Œæ•´æ­å»ºæ­¥éª¤ï¼šä» 0 åˆ° 1 å®ç°ä¸€ä¸ªåœ¨çº¿ä¼šè®®åº”ç”¨

æ•´ä¸ªåº”ç”¨çš„æ„å»º, ä»é¡¹ç›®åˆå§‹åŒ–åˆ°æœ€ç»ˆå¯ä»¥ä¸€é”®éƒ¨ç½², å…±åˆ†ä¸º 6 ä¸ªéƒ¨åˆ†. ä¸ºæ–¹ä¾¿è¯»è€…æŸ¥é˜…ï¼Œä¸»è¦çš„ä»£ç å®ç°åˆ†äº† 6 æ¬¡æäº¤, ä¸‹è¿°è¯´æ˜ä¸­ä¼šåˆ—å‡ºæ¯ä¸€æ­¥å¯¹åº”çš„æäº¤ commit.

### ç¬¬ 1 æ­¥ åˆå§‹åŒ–é¡¹ç›®å’Œè§†é¢‘é¡µé¢

#### æ³¨æ„è¦ç‚¹:

1. åœ¨è¿›è¡Œæ“ä½œä¹‹å‰, è¯·ç¡®ä¿å·²ç»æ³¨å†Œ[è…¾è®¯äº‘è´¦æˆ·](https://console.cloud.tencent.com/tcb/)
2. WebRTC éœ€è¦æµè§ˆå™¨æ”¯æŒ, åªæœ‰ç°ä»£æµè§ˆå™¨æ‰æ”¯æŒ, å»ºè®®ä½¿ç”¨ [Chrome](https://www.google.cn/chrome/)ã€Firefox æ¥ä½“éªŒ, å…·ä½“å…¼å®¹æ€§å¯æŸ¥çœ‹ [caniuse](https://caniuse.com/#search=webrtc)
3. ç”±äºå®‰å…¨ç­–ç•¥é™åˆ¶, WebRTC ä»…æ”¯æŒ https åè®®ç½‘ç«™; å…¶ä¸ºæ–¹ä¾¿æœ¬åœ°å¼€å‘, ä¹Ÿæ”¯æŒ http çš„ `localhost` åŠ `127.0.0.1` (ä¸é™ç«¯å£), ä¸æ”¯æŒå…¶ä»–è‡ªå®šä¹‰çš„æœ¬æœºåŸŸåã€IP
4. WebRTC å¹¶ä¸å…·å¤‡ç©¿é€å†…ç½‘åŠŸèƒ½, æµ‹è¯•ä½“éªŒæ—¶, ç¡®ä¿åŒæ–¹æœºå™¨éƒ½å¤„äºå…¬ç½‘ä¹‹ä¸­å¹¶èƒ½è®¿é—®[äº‘å¼€å‘](https://www.cloudbase.net)ç›¸å…³åŸŸå

#### æ“ä½œæ­¥éª¤

1. åˆå§‹åŒ–é¡¹ç›®ç»“æ„

é¦–å…ˆéœ€è¦å…¨å±€å®‰è£… [Cloudbase CLI](https://docs.cloudbase.net/quick-start/install-cli.html)

```
npm i @cloudbase/cli@latest -g
```

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥ä½¿ç”¨äº‘å¼€å‘çš„ react åº”ç”¨æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ª React äº‘å¼€å‘é¡¹ç›®

```bash
cloudbase init --template react-starter
```

2. å¼•å…¥ UI åº“ ant-design

```
npm i ant-d @ant-design/icons -S
```

3. å¢åŠ  landing é¡µ, ç”¨äºæ£€æµ‹ WebRTC èƒ½åŠ›ä»¥åŠåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æˆäºˆæ‘„åƒå¤´åŠéº¦å…‹é£è®¿é—®æƒé™

landing é¡µé¢æ ¸å¿ƒä»£ç  `meeting-simple/src/landing/index.js`

```js
import { LoadingOutlined, WarningOutlined } from "@ant-design/icons";
import React, { useEffect, useState } from "react";
import * as utils from "../utils";
// import * as api from './meeting/api'

export default function Landing(props) {
  // æ£€æµ‹ RTC æ”¯æŒ
  return !utils.isSupportRTC() ? (
    <NotSupport />
  ) : (
    <NotReady setReady={props.setReady} />
  );
}

// ä¸æ”¯æŒæ—¶çš„æ˜¾ç¤º
function NotSupport() {
  // ...
}

// æ”¯æŒ RTC æ—¶çš„æ˜¾ç¤º
function NotReady(props) {
  const [permissionState, setPermissionState] = useState("prompt");
  const [timeCount, setTimeCount] = useState(0);
  const [loadingState, setLoadingState] = useState("init");

  const retry = () => {
    setTimeCount(timeCount + 1);
  };

  // ä¸åŒçŠ¶æ€æ—¶çš„æç¤ºä¿¡æ¯ï¼Œpromptã€grantedã€denied
  const permissionStr = {
    prompt: (
      <p>
        Please allow camera and microphone access to continue, you can turn off
        camera or microphone later in meeting
      </p>
    ),
    denied: (
      <p>
        You should granted camera microphone permissions,{" "}
        <a onClick={retry}>click to retry</a>
      </p>
    ),
    granted: <p>Loading meeting info...</p>,
  };

  useEffect(() => {
    (async () => {
      // æ£€æµ‹æƒé™
      const status = await utils.checkMediaPermission();
      // è®¾ç½®æˆæƒä¿¡æ¯
      setPermissionState(status ? "granted" : "denied");
      if (!status) return;
      try {
        // ä»æµè§ˆå™¨å‚æ•°æ‹¿åˆ°ä¼šè¯ä¿¡æ¯
        const sessID = location.hash.slice(1);
        // if (sessID) {
        //   await api.getSessionInfo(sessID)
        // }
        props.setReady("landing");
      } catch (error) {
        console.warn("failed to get session info", error);
        setLoadingState("Failed to get meeting info: " + JSON.stringify(error));
      }
    })();
  }, [timeCount]);
  const tip =
    permissionStr[permissionState] ||
    (loadingState === "init" ? "loading..." : loadingState);
  return <div className="landing-mask"><!--loading ä¿¡æ¯--></div>;
}
```

4. å¢åŠ  Video-window é¡µ, ç”¨äºæ”¯æŒè§†é¢‘ç”»é¢æ˜¾ç¤º

Video-window æ ¸å¿ƒä»£ç  `meeting-simple/src/meeting/video-window/index.js`

```js
import React, { useRef, useEffect } from 'react';
import * as utils from '../../utils';

export default function VideoWindow(props) {
  const videoRef = useRef(null);

  useEffect(() => {
    const updateStream = (stream) => {
      // video å¯¹è±¡å¯¹åº”çš„dom
      const dom = videoRef.current;
      if (!dom) return;
      // è‡ªå·±åˆ™ mute é™éŸ³
      dom.muted = !props.peer;
      if ('srcObject' in dom) {
        dom.srcObject = stream;
        dom.onloadedmetadata = function () {
          dom.play();
        };
        return;
      }
      // è®¾ç½®å®æ—¶è§†é¢‘çš„ stream åœ°å€
      dom.src = URL.createObjectURL(stream);
      dom.play();
    };

    if (props.peer) {
      props.peer.on('stream', updateStream);
      return;
    }
    // è·å¾— mediaStream
    utils.getMediaStream().then(updateStream);

    return () => {
      if (!props.peer) return;
      props.peer.off('stream', updateStream);
    };
  }, [props.peer]);

  return (
    <video
      ref={videoRef}
      controls={!!props.peer}
      width="640"
      height="480"
    ></video>
  );
}
```

å·¥å…·æ–¹æ³•çš„æ ¸å¿ƒå®ç°`meeting-simple/src/utils.js`ï¼Œæ£€æµ‹æ˜¯å¦æ”¯æŒ WebRTCã€

```js
/** æ£€æŸ¥æ˜¯å¦æ”¯æŒ WebRTC */
export function isSupportRTC() {
  return !!navigator.mediaDevices;
}
// æ£€æµ‹æ˜¯å¦æœ‰mediaæƒé™
export async function checkMediaPermission() {
  // è¯·æ±‚è·å¾—åª’ä½“æµè¾“å…¥ï¼ˆåŒ…å«å£°éŸ³å’Œè§†é¢‘ï¼‰
  const stream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: true,
  });

  // åˆ¤æ–­æ˜¯å¦æœ‰è§†é¢‘å’Œå£°éŸ³è½¨é“è¾“å…¥
  const result =
    stream.getAudioTracks().length && stream.getVideoTracks().length;

  // ç»ˆæ­¢åª’ä½“æµè¾“å…¥
  revokeMediaStream(stream);

  return result;
}

// ç»ˆæ­¢åª’ä½“æµ
export function revokeMediaStream(stream) {
  if (!stream) return;
  const tracks = stream.getTracks();

  tracks.forEach(function (track) {
    track.stop();
  });
}

let cachedMediaStream = null;
export async function getMediaStream() {
  if (cachedMediaStream) {
    return Promise.resolve(cachedMediaStream);
  }
  // è¯·æ±‚åª’ä½“æµè¾“å…¥
  const stream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: true,
  });

  revokeMediaStream(cachedMediaStream);
  cachedMediaStream = stream;

  return cachedMediaStream;
}
```

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/a485865738b6ebbf668a49d0dd7876f7cd6ef17f)

### ç¬¬ 2 æ­¥ æ”¯æŒåˆ›å»ºä¼šè®®

#### æ³¨æ„è¦ç‚¹:

1. æµè§ˆå™¨ç«¯è°ƒç”¨äº‘å¼€å‘èƒ½åŠ›éœ€è¦å€ŸåŠ©å®˜æ–¹ npm åŒ… [tcb-js-sdk](https://www.npmjs.com/package/tcb-js-sdk), [å®˜æ–¹æ–‡æ¡£](https://docs.cloudbase.net/api-reference/webv2/initialization.html)
2. å› ä¸ºè§†é¢‘ä¼šè®®åº”ç”¨æ— éœ€æ³¨å†Œ, å³éœ€è¦åŒ¿åä½¿ç”¨äº‘å¼€å‘èƒ½åŠ›, è°ƒç”¨èƒ½åŠ›å‰, éœ€è¦åœ¨äº‘å¼€å‘ [ç™»å½•æˆæƒ](https://console.cloud.tencent.com/tcb/env/login) ä¸­å¼€å¯ ã€ŒåŒ¿åç™»å½•ã€
3. ä½¿ç”¨äº‘å¼€å‘èƒ½åŠ›(ä¸è®ºæ˜¯åœ¨æµè§ˆå™¨ç«¯ã€Node ç«¯æˆ–å…¶ä»–ç«¯)è°ƒç”¨æ•°æ®åº“æ—¶, æ“ä½œç«¯ collection å¿…é¡»å­˜åœ¨, å¦åˆ™ä¼šæŠ¥é”™. æ‰€ä»¥åœ¨æœ¬æ­¥éª¤åº”å½“æå‰è¿›å…¥[äº‘å¼€å‘æ•°æ®åº“æ§åˆ¶å°](https://console.cloud.tencent.com/tcb/db/index) åˆ›å»ºè§†é¢‘ä¼šè®®ä½¿ç”¨çš„ collection `meeting-simple`
4. ä½¿ç”¨ JS sdk è°ƒç”¨äº‘å¼€å‘èƒ½åŠ›æ—¶, éœ€ä¿è¯è°ƒç”¨çš„åŸŸåå·²åŠ å…¥äº‘å¼€å‘[WEB å®‰å…¨åŸŸå](https://console.cloud.tencent.com/tcb/env/safety)ä¸­, ä»¥é¿å…è°ƒç”¨æ—¶å‡ºç°è·¨åŸŸé—®é¢˜. å³æœ¬åœ°å¼€å‘ä½¿ç”¨çš„åŸŸååº”å¢åŠ è¿› WEB å®‰å…¨åŸŸå ä¸­.

#### æ“ä½œæ­¥éª¤

1. å¢åŠ  ã€Œåˆ›å»ºä¼šè®®ã€ç•Œé¢
2. å¢åŠ äº‘å¼€å‘èƒ½åŠ›è°ƒç”¨æ¨¡å— ã€Œapi.jsã€, æ·»åŠ  åˆ›å»ºä¼šè®®æ–¹æ³•(é€šè¿‡äº‘å¼€å‘ js sdk è¿æ¥æ•°æ®åº“åˆ›å»ºè®°å½•)

åˆ›å»ºä¼šè®®çš„å‰ç«¯ API æ ¸å¿ƒä»£ç  `meeting-simple/src/meeting/api.js`

```js
import tcb from 'tcb-js-sdk';

// åˆå§‹åŒ–äº‘å¼€å‘ JSSDK
const app = tcb.init({
  env: 'tcb-demo-10cf5b',
});

// åˆå§‹åŒ– auth
const auth = app.auth({
  persistence: 'local',
});

const db = app.database();

// ä¼šè®®è¡¨åç§°
const MEETING_COLLECTION = 'meeting-simple';

// åŒ¿åç™»å½•
async function signIn() {
  if (auth.hasLoginState()) return true;
  await auth.signInAnonymously();
  return true;
}

// åˆ›å»ºä¼šè®®
export async function createMeeting(meeting) {
  await signIn();
  meeting.createdAt = Date.now();
  // æ·»åŠ ä¸€æ¡ä¼šè®®çš„è®°å½•
  const result = await db.collection(MEETING_COLLECTION).add(meeting);
  return result;
}
```

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/ecc61be1ba59f7910ebcffe425e0c53edf0160b5)

### ç¬¬ 3 æ­¥ å®ç°åŠ å…¥ä¼šè®®åŠŸèƒ½

#### æ“ä½œæ­¥éª¤

1. å¢åŠ  ã€ŒåŠ å…¥ä¼šè®®ã€ç•Œé¢
2. åœ¨ ã€Œapi.jsã€ä¸­å¢åŠ æ–¹æ³•(ç›´æ¥è°ƒç”¨äº‘å¼€å‘æ•°æ®åº“èƒ½åŠ›)è·å–ä¼šè®®ä¿¡æ¯ã€åŠ å…¥ä¼šè®®

è·å–ä¼šè®®ä¿¡æ¯å’ŒåŠ å…¥ä¼šè®®çš„å‰ç«¯ API çš„æ ¸å¿ƒä»£ç  `meeting-simple/src/meeting/api.js`

```js
// è·å–ä¼šè®®ä¿¡æ¯
export async function getMeeting(meetingId) {
  await signIn();
  // è°ƒç”¨ db æŸ¥è¯¢æ•°æ®
  const result = await db.collection(MEETING_COLLECTION).doc(meetingId).get();
  if (!result.data || !result.data.length) return;
  const meeting = result.data[0];

  meeting.hasPass = !!meeting.pass;
  delete meeting.pass;
  return meeting;
}

// åŠ å…¥ä¼šè®®
export async function joinMeeting(data) {
  await signIn();
  // æŸ¥è¯¢ä¼šè®®ä¿¡æ¯
  const result = await db.collection(MEETING_COLLECTION).doc(data.id).get();
  if (!result.data || !result.data.length)
    throw new Error('meeting not exists');

  const meeting = result.data[0];
  // å‰ç«¯å¯¹æ¯”ä¼šè®® pass ç æ¥éªŒè¯ï¼Œå®‰å…¨æ€§è¾ƒä½ï¼Œä¼šåœ¨ç¬¬ 5 æ­¥è¿›è¡Œä¼˜åŒ–
  if (meeting.pass && meeting.pass === data.pass)
    throw new Error('passcode not match');
  return true;
}
```

æ³¨:

1. æ•°æ®åº“éœ€è¦è®¾ç½®æˆå…¬å¼€è®¿é—®, å¦åˆ™åŒ¿åç”¨æˆ·æ— æ³•æŸ¥è¯¢åˆ°ç›¸å…³ä¿¡æ¯: è¿›å…¥æ•°æ®åº“æ‰¾åˆ°å¯¹åº” [collection](https://console.cloud.tencent.com/tcb/database/collection/meeting-simple), åˆ‡æ¢è‡³ ã€Œæƒé™è®¾ç½®ã€, é€‰æ‹© ã€Œæ‰€æœ‰ç”¨æˆ·å¯è¯»ï¼Œä»…åˆ›å»ºè€…åŠç®¡ç†å‘˜å¯å†™ã€å¹¶ä¿å­˜

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/c8d9edcfc193e152ea5f3422aa4621c98399f819)

## ç¬¬ 4 æ­¥ å®ç°å®æ—¶åŠ å…¥ä¼šè®®

#### æ“ä½œæ­¥éª¤

1. å¢åŠ  simple-peer æ¥ç®¡ç† WebRTC å®¢æˆ·ç«¯

```js
import Peer from 'simple-peer';
import * as utils from './utils';
import * as api from './api';

export async function createPeer(initiator, meetingId) {
  const peer = new Peer({ initiator });
  const stream = await utils.getMediaStream();
  peer.addStream(stream);

  // peer æ¥æ”¶åˆ° signal äº‹ä»¶æ—¶ï¼Œè°ƒç”¨ peer.signal(data) æ¥å»ºç«‹è¿æ¥ï¼Œé‚£ä¹ˆå¦‚ä½•æ‹¿åˆ° data ä¿¡æ¯å‘¢
  peer.on('signal', (e) => {
    console.log('[peer event]signal', e);
    // è°ƒç”¨æ›´æ–°å†™å…¥æ•°æ®åº“
    updateTicket(e, initiator, meetingId);
  });
  peer.on('connect', (e) => {
    console.log('[peer event]connect', e);
  });
  peer.on('data', (e) => {
    console.log('[peer event]data', e);
  });
  peer.on('stream', (e) => {
    console.log('[peer event]stream', e);
  });
  peer.on('track', (e) => {
    console.log('[peer event]track', e);
  });
  peer.on('close', () => {
    console.log('[peer event]close');
  });
  peer.on('error', (e) => {
    console.log('[peer event]error', e);
  });
  return peer;
}

let cachedTickets = [];
let tid = 0;

function updateTicket(signal, isInitiator, meetingId) {
  cachedTickets.push(signal);
  clearTimeout(tid);
  tid = setTimeout(async () => {
    const tickets = cachedTickets.splice(0);
    try {
      // å†™å…¥æ•°æ®åº“
      const result = await api.updateTicket({
        meetingId,
        tickets,
        type: isInitiator ? 'offer' : 'answer',
      });
      console.warn('[updateTicket] success', result);
    } catch (error) {
      console.warn('[updateTicket] failed', error);
    }
  }, 100);
}

export function signalTickets(peer, tickets) {
  tickets.forEach((item) => {
    peer.signal(item);
  });
}
```

2. å¢åŠ äº‘å‡½æ•° ã€Œæ›´æ–° ticketã€(ç”¨äºæ›´æ–° WebRTC å®¢æˆ·ç«¯çš„è¿æ¥ä¿¡æ¯)å¹¶æ‰‹åŠ¨éƒ¨ç½²äº‘å‡½æ•°, å¢åŠ å¯¹ä¼šè®®è®°å½•å¯¹ç›‘å¬(å³ä½¿ç”¨æ•°æ®åº“çš„å®æ—¶æ¨é€èƒ½åŠ›)

ç”¨äºæ›´æ–° WebRTC å®¢æˆ·ç«¯çš„è¿æ¥ä¿¡æ¯çš„äº‘å‡½æ•°çš„æ ¸å¿ƒä»£ç  `meeting-simple/cloudfunctions/update-ticket-meeting-simple/index.js`

```js
const cloud = require("@cloudbase/node-sdk");

   const MEETING_COLLECTION = "meeting-simple";

   exports.main = async (data) => {
  const app = cloud.init({
       env: cloud.SYMBOL_CURRENT_ENV,
     });

     const collection = app.database().collection(MEETING_COLLECTION);

     try {
    // æŸ¥è¯¢ä¼šè®®ä¿¡æ¯
       const result = await collection.doc(data.meetingId).get();
       if (!result.data || !result.data.length)
         throw new Error("meeting not exists");
       const meeting = result.data[0];

       const changed = {};
    changed[data.type] = meeting[data.type] ||

       // è‹¥æ–°çš„ticketsä¸­åŒ…å« offer æˆ– answer, åˆ™å·²ç»å­˜å‚¨çš„ticketsä¿¡æ¯æ— æ•ˆ
    if (data.tickets.some((tk) => ["offer", "answer"].includes(tk.type))) {
         changed[data.type] = data.tickets;
       } else {
         changed[data.type].push(...data.tickets);
       }

       // å¦ä¸€æ–¹ä¿¡æ¯å·²ç»è¢«æ¥å—ä½¿ç”¨, å·²æ— æ•ˆ, æ¸…ç©ºä¹‹, é¿å… å®¢æˆ·ç«¯ watch æ—¶ä½¿ç”¨æ— æ•ˆæ•°æ®
    changed[data.type === "offer" ? "answer" : "offer"] = null;

       // æ›´æ–°ä¼šè®®ä¿¡æ¯
    const res = await collection.doc(data.meetingId).update(changed);
       return {
         code: 0,
         data: res,
       };
     } catch (error) {
       return {
         code: 1,
         message: error.message,
       };
     }
   };
```

æ›´æ–°ç¥¨æ®å’Œç›‘å¬ä¼šè®®ä¿¡æ¯å˜æ›´çš„å‰ç«¯ API æ ¸å¿ƒä»£ç  meeting-simple/src/meeting/api.js

```js
// æ›´æ–°ç¥¨æ®
export async function updateTicket(data) {
  await signIn();
  const res = await app.callFunction({
    name: 'update-ticket-meeting-simple',
    data,
  });
  return res;
}

let watcher = null;
export async function watchMeeting(meetingId, onChange) {
  await signIn();

  // å¦‚æœæœ‰ç›‘å¬ï¼Œå…³é—­ç›‘å¬
  watcher && watcher.close();

  // æ–°å»ºæ•°æ®åº“ç›‘å¬
  watcher = db
    .collection(MEETING_COLLECTION)
    .doc(meetingId)
    .watch({
      onChange: (snapshot) => {
        console.error(snapshot);

        if (
          !snapshot.docChanges ||
          !snapshot.docChanges.length ||
          !snapshot.docChanges[0].doc
        )
          return;

        // å›è°ƒæœ€æ–°çš„æ•°æ®åº“æ–‡æ¡£ä¿¡æ¯
        onChange(snapshot.docChanges[0].doc);
      },
      onError: (err) => {
        console.log('watch error', err);
      },
    });
}
```

3. ä¼˜åŒ–ä¼šè®®ä¿¡æ¯çš„è·å–æå‡ä½“éªŒ

#### æ³¨æ„

1. ç›‘å¬æ•°æ®åº“å˜åŒ–äº¦éœ€è¦å°†æ•°æ®åº“è®¾ç½®ä¸ºå…¬å¼€è®¿é—®, å³ä¸Šè¿°ç¬¬ä¸‰æ­¥ä¸­çš„æ³¨æ„äº‹é¡¹ 2 æ‰€è¿°
2. åŒ¿åç”¨æˆ·æ— æ³•ä¿®æ”¹å…¶ä»–åŒ¿åç”¨æˆ·åˆ›å»ºçš„è®°å½•. æ ¹æ®æ•°æ®åº“å®‰å…¨ç­–ç•¥, è™½åŒä¸ºåŒ¿åç”¨æˆ·, ä½†ä¸åŒå®¢æˆ·ç«¯çš„åŒ¿åç”¨æˆ·æ ‡å¿—ä¸ä¸€æ ·, æ•…ä¸èƒ½æ“ä½œä»–äººçš„è®°å½•. è€Œäº‘å‡½æ•°æœ‰ç”¨ç®¡ç†å‘˜çº§åˆ«çš„æ•°æ®åº“æ“ä½œæƒé™, æ•… ã€Œæ›´æ–° ticketã€åŠŸèƒ½é‡‡ç”¨äº†äº‘å‡½æ•°æ¥ç¼–å†™

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/607512a28d697e6c2d60efe795d449a483fe40b8)

### ç¬¬ 5 æ­¥ æå‡éå…¬å¼€ä¼šè®®è®¿é—®çš„å®‰å…¨æ€§, ä¼˜åŒ–æ•°æ®åº“ä½¿ç”¨

#### æ“ä½œæ­¥éª¤

1. å°†ä¼šè®®å¯†ç åˆ†è¡¨å­˜å‚¨

ä¿®æ”¹â€œåŠ å…¥ä¼šè®®â€çš„å‰ç«¯ API æ ¸å¿ƒä»£ç  `meeting-simple/src/meeting/api.js`

```js
// åŠ å…¥ä¼šè®®
export async function joinMeeting(data) {
  await signIn();
  // åŠ å…¥ä¼šè®®æ”¹ä¸ºä½¿ç”¨è°ƒç”¨äº‘å‡½æ•°æ ¡éªŒï¼Œä¿è¯å¯†ç å®‰å…¨
  const result = await app.callFunction({
    name: 'join-meeting-meeting-simple',
    data,
  });
  if (result.result.code) {
    throw new Error(result.result.message);
  }

  return true;
}
```

è´Ÿè´£åŠ å…¥ä¼šè®®æ—¶è¿›è¡Œå¯†ç æ ¡éªŒçš„äº‘å‡½æ•°çš„æ ¸å¿ƒä»£ç  `meeting-simple/cloudfunctions/join-meeting-meeting-simple/index.js`

```js
const tcb = require('@cloudbase/node-sdk');
const MEETING_COLLECTION = 'meeting-simple';
const MEETING_PASS_COLLECTION = 'meeting-simple-pass';
const app = tcb.init({
  env: tcb.SYMBOL_CURRENT_ENV,
});
const db = app.database();

exports.main = async function (evt) {
  try {
    const result = await db.collection(MEETING_COLLECTION).doc(evt.id).get();
    if (!result.data || !result.data.length)
      return { code: 1, message: 'meeting not exists' };
    const meeting = result.data[0];

    if (meeting.hasPass) {
      // æŸ¥è¯¢ä¼šè®®å¯†ç 
      const passResult = await db
        .collection(MEETING_PASS_COLLECTION)
        .where({ meetingId: evt.id })
        .get();
      if (!passResult.data || !passResult.data.length)
        return { code: 2, message: 'passcode not found' };
      const passInfo = passResult.data[0];
      // å¯¹æ¯”ä¼šè®®å¯†ç 
      if (passInfo.pass !== evt.pass)
        return {
          code: 3,
          message: 'passcode not match',
        };
    }
    return { code: 0 };
  } catch (error) {
    return {
      code: 3,
      message: error.message,
    };
  }
};
```

2. æ•°æ®åº“ collection å®šæœŸæ¸…ç†æ—§çš„æ— ç”¨è®°å½•

æ¸…ç†æ•°æ®çš„äº‘å‡½æ•°çš„æ ¸å¿ƒå®ç°`meeting-simple/cloudfunctions/autoclear-meeting-meeting-simple/index.js`

```js
const tcb = require('@cloudbase/node-sdk');
const MEETING_COLLECTION = 'meeting-simple';
const MEETING_PASS_COLLECTION = 'meeting-simple-pass';
const app = tcb.init({
  env: tcb.SYMBOL_CURRENT_ENV,
});
const db = app.database();
/**
 * å®šæ—¶è§¦å‘, æ¸…ç†ä¸¤å¤©å‰çš„ä¼šè®®è®°å½•
 *
{
    "triggers": [
        {
            "name": "clear-time-trigger",
            "type": "timer",
            "config": "0 0 2 * * * *"
        }
    ]
}
 */

exports.main = async function () {
  const now = Date.now();
  // 2å¤©å‰
  const threshold = now - 2 * 24 * 60 * 60 * 1000;
  const _ = db.command;
  try {
    // æŸ¥è¯¢åˆ›å»ºæ—¶é—´ä¸¤å¤©å‰çš„ä¼šè®®è®°å½•ï¼Œè¿›è¡Œåˆ é™¤
    await db
      .collection(MEETING_COLLECTION)
      .where({
        createdAt: _.lte(threshold),
      })
      .remove();

    // æŸ¥è¯¢åˆ›å»ºæ—¶é—´ä¸¤å¤©å‰çš„å¯†ç è®°å½•ï¼Œè¿›è¡Œåˆ é™¤
    await db
      .collection(MEETING_PASS_COLLECTION)
      .where({
        createdAt: _.lte(threshold),
      })
      .remove();
  } catch (error) {
    console.log('failed to batch remove', error);
  }
};
```

#### æ³¨æ„:

1. å®šæœŸæ¸…ç†æ•°æ®åº“ä½¿ç”¨äº†äº‘å‡½æ•°çš„[å®šæ—¶è§¦å‘å™¨](https://docs.cloudbase.net/cloud-function/timer-trigger.html)

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/1cd2ebff769d06b29a34b245984d8fc61df17444)

### ç¬¬ 6 æ­¥ ä½¿ç”¨ cloudbase framework ä¸€é”®éƒ¨ç½²

1. å¢åŠ é™æ€éƒ¨ç½²åŠŸèƒ½, ä½¿ç”¨äº† [website æ’ä»¶](https://github.com/Tencent/cloudbase-framework/tree/master/packages/framework-plugin-website)
2. å¢åŠ éƒ¨ç½²äº‘å‡½æ•°åŠŸèƒ½, åŒ…æ‹¬äº‘å‡½æ•°å®šæ—¶è°ƒç”¨çš„è®¾ç½®, ä½¿ç”¨äº†[function æ’ä»¶](https://github.com/Tencent/cloudbase-framework/blob/master/packages/framework-plugin-function/README.md)
3. å¢åŠ æ•°æ® collection çš„åˆ›å»º, åŒ…æ‹¬ collection è®¿é—®æƒé™çš„è®¾ç½®, ä½¿ç”¨äº† [database æ’ä»¶](https://github.com/Tencent/cloudbase-framework/blob/master/packages/framework-plugin-database/README.md)

åœ¨ `meeting-simple/.env` æ–‡ä»¶ä¸­å£°æ˜ç¯å¢ƒå˜é‡ä¿¡æ¯

```
PUBLIC_URL=./
ENV_ID=tcb-demo-10cf5b
```

åœ¨ `meeting-simple/cloudbaserc.json` æ–‡ä»¶ä¸­å£°æ˜é™æ€èµ„æºã€äº‘å‡½æ•°å’Œæ•°æ®åº“ç­‰å„ä¸ªèµ„æºçš„æ„å»ºå’Œéƒ¨ç½²ä¿¡æ¯

```json
{
  "envId": "{{env.ENV_ID}}",
  "$schema": "https://framework-1258016615.tcloudbaseapp.com/schema/latest.json",
  "version": "2.0",
  "functionRoot": "cloudfunctions",
  "framework": {
    "plugins": {
      "client": {
        "use": "@cloudbase/framework-plugin-website",
        "inputs": {
          "buildCommand": "npm run build",
          "outputPath": "build",
          "cloudPath": "/meeting-simple",
          "envVariables": {
            "REACT_APP_ENV_ID": "{{env.ENV_ID}}"
          }
        }
      },
      "db": {
        "use": "@cloudbase/framework-plugin-database",
        "inputs": {
          "collections": [
            {
              "collectionName": "meeting-simple",
              "aclTag": "READONLY"
            },
            {
              "collectionName": "meeting-simple-pass"
            }
          ]
        }
      },
      "server": {
        "use": "@cloudbase/framework-plugin-function",
        "inputs": {
          "functionRootPath": "cloudfunctions",
          "functions": [
            {
              "name": "autoclear-meeting-meeting-simple",
              "triggers": [
                {
                  "name": "clear-time-trigger",
                  "type": "timer",
                  "config": "0 0 2 * * * *"
                }
              ]
            },
            { "name": "join-meeting-meeting-simple" },
            { "name": "create-meeting-meeting-simple" },
            { "name": "update-ticket-meeting-simple" }
          ]
        }
      }
    }
  }
}
```

æ‰§è¡Œ ClouBase Framework çš„ä¸€é”®éƒ¨ç½²å‘½ä»¤

```bash
cloudbase framework deploy
```

![](https://tva1.sinaimg.cn/large/007S8ZIlgy1gib81yq9zlj30sq0gp44r.jpg)

æ›´å¤š CloudBase Framework æ’ä»¶å¯é˜…è¯»[CloudBase Framework å®˜æ–¹æ–‡æ¡£](https://github.com/Tencent/cloudbase-framework#%E7%9B%AE%E5%89%8D%E6%94%AF%E6%8C%81%E7%9A%84%E6%8F%92%E4%BB%B6%E5%88%97%E8%A1%A8)

#### ä»£ç æäº¤è®°å½•

æœ¬æ­¥éª¤å¯¹åº”çš„ [git commit](https://github.com/oe/serverless-zoom-with-webrtc/commit/ec4c008e187b4b93d98fb351ffce2cd64e4c447d)

## æ€»ç»“

åœ¨æœ¬æ¬¡å®æˆ˜æ¡ˆä¾‹é‡Œé¢ï¼Œæˆ‘ä»¬é€šè¿‡äº†è§£äº† WebRTC çš„åŸºæœ¬ä½¿ç”¨ï¼Œé€šè¿‡åœ¨çº¿ä¼šè®®ç³»ç»Ÿçš„å®æˆ˜äº†è§£äº†åŸºäºäº‘å¼€å‘å¼€å‘ä¸€ä¸ªåº”ç”¨çš„å®Œæ•´æµç¨‹ï¼Œå­¦ä¼šä½¿ç”¨äº†æ•°æ®åº“å®æ—¶æ¨é€èƒ½åŠ›çš„ä½¿ç”¨ã€åŒ¿åç”¨æˆ·ä½¿ç”¨æ•°æ®åº“çš„å®‰å…¨ç­–ç•¥é—®é¢˜åŠäº‘å‡½æ•°å®šæ—¶è°ƒç”¨åŠŸèƒ½ï¼ŒæŒæ¡äº†ä½¿ç”¨ CloudBase Framework ä¸€é”®éƒ¨ç½²å‰åç«¯åº”ç”¨è¿™ä¸€å·¥å…·æ¥å¿«é€Ÿäº¤ä»˜ã€‚

---

## CloudBase Framework å¼€æºé¡¹ç›®ä»‹ç»

ğŸš€ CloudBase Framework æ˜¯äº‘å¼€å‘å¼€æºçš„äº‘åŸç”Ÿå‰åç«¯ä¸€ä½“åŒ–éƒ¨ç½²å·¥å…·ï¼Œæ”¯æŒä¸»æµå‰åç«¯æ¡†æ¶ï¼Œå‰åç«¯ä¸€é”®æ‰˜ç®¡éƒ¨ç½²åœ¨äº‘ç«¯ä¸€ä½“åŒ–å¹³å°ï¼Œæ”¯æŒæ”¯æŒå°ç¨‹åºã€Webã€Flutterã€åç«¯æœåŠ¡ç­‰å¤šä¸ªå¹³å°ã€‚

Github å¼€æºåœ°å€ï¼š[https://github.com/Tencent/cloudbase-framework](https://github.com/Tencent/cloudbase-framework)

æ¬¢è¿ç»™ CloudBase Framework ä¸€ä¸ª ğŸŒŸ star

## CloudBase Framework æ ¸å¿ƒè´¡çŒ®è€…è®¡åˆ’

æ¬¢è¿å¤§å®¶å‚ä¸ CloudBase Framework çš„å¼€å‘å·¥ä½œï¼Œæˆä¸ºæˆ‘ä»¬çš„è´¡çŒ®è€…ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨äº‘å¼€å‘ç¤¾åŒºå±•ç¤ºè´¡çŒ®è€…çš„ä½œå“å’Œä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæœ‰æƒŠå–œå¥–åŠ±ã€‚

æ‚¨å¯ä»¥é€‰æ‹©å¦‚ä¸‹çš„è´¡çŒ®æ–¹å¼ï¼š

- è´¡çŒ®æŠ€æœ¯æ–‡ç« ï¼š[https://github.com/Tencent/cloudbase-framework/tree/master/community/posts](https://github.com/Tencent/cloudbase-framework/tree/master/community/posts)
- è´¡çŒ®åº”ç”¨ï¼š[https://github.com/Tencent/cloudbase-framework/blob/master/doc/app.md](https://github.com/Tencent/cloudbase-framework/blob/master/doc/app.md)
- è´¡çŒ®ä»£ç ï¼Œæäº¤ Pull Request
- åé¦ˆ bugï¼Œæäº¤ Issue
- åœ¨æŠ€æœ¯ä¼šè®®ä¸Šå‘è¡¨æŠ€æœ¯æ¼”è®²

CloudBase Framework çš„å‘å±•ç¦»ä¸å¼€ç¤¾åŒºçš„ç§¯æè´¡çŒ®ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒè´¡çŒ®è€…åˆ—è¡¨ï¼Œå†æ¬¡æ„Ÿè°¢å¤§å®¶çš„è´¡çŒ®ï¼š[https://github.com/Tencent/cloudbase-framework#contributors-](https://github.com/Tencent/cloudbase-framework#contributors-)
